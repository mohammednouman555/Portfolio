<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">

<style>

body {
    background: #f4f4f4;
    font-family: Arial, sans-serif;
}

.dashboard {
    max-width: 900px;
    margin: auto;
    padding: 30px;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}

.message-card {
    background: white;
    padding: 15px;
    margin: 15px 0;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
}

.message-card button {
    margin-right: 10px;
    padding: 6px 12px;
    cursor: pointer;
}

.read {
    opacity: 0.6;
}

#pagination button {
    margin: 5px;
    padding: 6px 12px;
    cursor: pointer;
}

.search-box input {
    padding: 6px;
}

</style>
</head>

<body>

<div class="dashboard">

    <div class="top-bar">
        <h2>Admin Dashboard</h2>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search name or email">
            <button onclick="handleSearch()">Search</button>
        </div>

        <button onclick="logout()">Logout</button>
    </div>

    <hr>

    <div id="messages">Loading...</div>
    <div id="pagination"></div>

</div>

<script>

const API_URL = "https://portfolio-backend-rgbj.onrender.com";
const token = localStorage.getItem("ADMIN_TOKEN");

let currentPage = 1;
let currentSearch = "";
const limit = 5;

if (!token) {
    window.location.href = "login.html";
}


// ================= LOAD MESSAGES =================

async function loadMessages(page = 1, search = "") {

    currentPage = page;
    currentSearch = search;

    try {

        const res = await fetch(
            `${API_URL}/admin/messages?page=${page}&limit=${limit}&search=${search}`,
            {
                headers: {
                    "Authorization": "Bearer " + token
                }
            }
        );

        if (res.status === 401) {
            logout();
            return;
        }

        const data = await res.json();

        renderMessages(data.messages);
        renderPagination(data.total);

    } catch {
        document.getElementById("messages").innerText =
            "Server error. Try again later.";
    }
}


// ================= RENDER MESSAGES =================

function renderMessages(messages) {

    const box = document.getElementById("messages");
    box.innerHTML = "";

    if (messages.length === 0) {
        box.innerText = "No messages found.";
        return;
    }

    messages.forEach(msg => {

        const div = document.createElement("div");
        div.className = "message-card";

        if (msg.is_read) div.classList.add("read");

        div.innerHTML = `
            <p><strong>Name:</strong> ${msg.name}</p>
            <p><strong>Email:</strong> ${msg.email}</p>
            <p><strong>Message:</strong> ${msg.message}</p>
            <p><small>${new Date(msg.created_at).toLocaleString()}</small></p>

            <button onclick="toggleRead(${msg.id})">
                ${msg.is_read ? "Mark Unread" : "Mark Read"}
            </button>

            <button onclick="deleteMessage(${msg.id})">
                Delete
            </button>
        `;

        box.appendChild(div);
    });
}


// ================= PAGINATION =================

function renderPagination(total) {

    const totalPages = Math.ceil(total / limit);
    const pagination = document.getElementById("pagination");

    pagination.innerHTML = "";

    for (let i = 1; i <= totalPages; i++) {

        const btn = document.createElement("button");
        btn.innerText = i;

        if (i === currentPage) {
            btn.disabled = true;
        }

        btn.onclick = () => loadMessages(i, currentSearch);

        pagination.appendChild(btn);
    }
}


// ================= TOGGLE READ =================

async function toggleRead(id) {

    await fetch(
        `${API_URL}/admin/messages/${id}/toggle-read`,
        {
            method: "PUT",
            headers: {
                "Authorization": "Bearer " + token
            }
        }
    );

    loadMessages(currentPage, currentSearch);
}


// ================= DELETE =================

async function deleteMessage(id) {

    if (!confirm("Delete this message?")) return;

    await fetch(
        `${API_URL}/admin/messages/${id}`,
        {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        }
    );

    loadMessages(currentPage, currentSearch);
}


// ================= SEARCH =================

function handleSearch() {
    const value = document.getElementById("searchInput").value;
    loadMessages(1, value);
}


// ================= LOGOUT =================

function logout() {
    localStorage.removeItem("ADMIN_TOKEN");
    window.location.href = "login.html";
}


// ================= INIT =================

loadMessages();

</script>

</body>
</html>