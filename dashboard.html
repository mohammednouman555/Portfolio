<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">

<style>

body {
    background: #f4f6f9;
}

/* ================= DASHBOARD ================= */

.dashboard {
    max-width: 1100px;
    margin: auto;
    padding: 30px;
}

/* ================= TOP BAR ================= */

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

/* ================= STATS ================= */

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-box {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 0 10px rgba(0,0,0,0.12);
}

.stat-box h3 {
    margin: 0;
    font-size: 26px;
    color: #03045e;
}

.stat-box p {
    margin: 8px 0 0;
    color: #555;
    font-weight: bold;
}

/* ================= MESSAGES ================= */

.message-card {
    background: white;
    padding: 15px;
    margin: 15px 0;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
}

.message-card button {
    margin-right: 10px;
    padding: 6px 12px;
    cursor: pointer;
}

.read {
    opacity: 0.6;
}

</style>

</head>
<body>

<div class="dashboard">

    <!-- TOP BAR -->
    <div class="top-bar">
        <h2>Admin Dashboard</h2>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- STATS -->
    <div class="stats">

        <div class="stat-box">
            <h3 id="totalCount">0</h3>
            <p>Total Messages</p>
        </div>

        <div class="stat-box">
            <h3 id="readCount">0</h3>
            <p>Read</p>
        </div>

        <div class="stat-box">
            <h3 id="unreadCount">0</h3>
            <p>Unread</p>
        </div>

        <div class="stat-box">
            <h3 id="lastTime">--</h3>
            <p>Last Message</p>
        </div>

    </div>

    <hr>

    <!-- MESSAGES -->
    <div id="messages">Loading...</div>

</div>


<script>

const API_URL = "https://portfolio-backend-rgbj.onrender.com";
const token = localStorage.getItem("ADMIN_TOKEN");


/* ================= AUTH ================= */

if (!token) {
    window.location.href = "login.html";
}


/* ================= LOAD STATS ================= */

async function loadStats() {

    try {

        const res = await fetch(API_URL + "/admin/stats", {
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        if (res.status === 401) {
            logout();
            return;
        }

        const data = await res.json();

        document.getElementById("totalCount").innerText =
            data.total_messages;

        document.getElementById("readCount").innerText =
            data.read_messages;

        document.getElementById("unreadCount").innerText =
            data.unread_messages;

        document.getElementById("lastTime").innerText =
            data.last_message_time
                ? new Date(data.last_message_time).toLocaleString()
                : "--";

    } catch {

        console.log("Stats load failed");

    }

}


/* ================= LOAD MESSAGES ================= */

async function loadMessages() {

    try {

        const res = await fetch(API_URL + "/admin/messages", {
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        if (res.status === 401) {
            logout();
            return;
        }

        const data = await res.json();

        renderMessages(data.messages || data);

    } catch {

        document.getElementById("messages").innerText =
            "Server error. Try again later.";

    }

}


/* ================= RENDER ================= */

function renderMessages(messages) {

    const box = document.getElementById("messages");

    box.innerHTML = "";

    if (messages.length === 0) {
        box.innerText = "No messages yet.";
        return;
    }

    messages.forEach(msg => {

        const div = document.createElement("div");

        div.className = "message-card";

        if (msg.is_read) {
            div.classList.add("read");
        }

        div.innerHTML = `
            <p><strong>Name:</strong> ${msg.name}</p>
            <p><strong>Email:</strong> ${msg.email}</p>
            <p><strong>Message:</strong> ${msg.message}</p>
            <p><small>${new Date(msg.created_at).toLocaleString()}</small></p>

            <button onclick="toggleRead(${msg.id})">
                ${msg.is_read ? "Mark Unread" : "Mark Read"}
            </button>

            <button onclick="deleteMessage(${msg.id})">
                Delete
            </button>
        `;

        box.appendChild(div);

    });

}


/* ================= TOGGLE ================= */

async function toggleRead(id) {

    try {

        const res = await fetch(
            API_URL + `/admin/messages/${id}/toggle-read`,
            {
                method: "PUT",
                headers: {
                    "Authorization": "Bearer " + token
                }
            }
        );

        if (res.status === 401) {
            logout();
            return;
        }

        loadMessages();
        loadStats();

    } catch {

        alert("Update failed");

    }

}


/* ================= DELETE ================= */

async function deleteMessage(id) {

    if (!confirm("Delete this message?")) return;

    try {

        const res = await fetch(
            API_URL + `/admin/messages/${id}`,
            {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            }
        );

        if (res.status === 401) {
            logout();
            return;
        }

        loadMessages();
        loadStats();

    } catch {

        alert("Delete failed");

    }

}


/* ================= LOGOUT ================= */

function logout() {

    localStorage.removeItem("ADMIN_TOKEN");

    window.location.href = "login.html";

}


/* ================= INIT ================= */

loadStats();
loadMessages();

</script>

</body>
</html>