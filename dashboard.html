<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">

<style>

.dashboard {
    max-width: 900px;
    margin: auto;
    padding: 30px;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.message-card {
    background: white;
    padding: 15px;
    margin: 15px 0;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
}

.message-card button {
    margin-right: 10px;
    padding: 6px 12px;
    cursor: pointer;
}

.read {
    opacity: 0.6;
}

</style>

</head>
<body>

<div class="dashboard">

    <div class="top-bar">

        <h2>Admin Dashboard</h2>

        <button onclick="logout()">Logout</button>

    </div>

    <hr>

    <div id="messages">Loading...</div>

</div>


<script>

const API_URL = "https://portfolio-backend-rgbj.onrender.com";

// ================= AUTH CHECK =================

const token = localStorage.getItem("ADMIN_TOKEN");

if (!token) {
    window.location.href = "login.html";
}


// ================= LOAD MESSAGES =================

async function loadMessages() {

    try {

        const res = await fetch(API_URL + "/admin/messages", {
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        // Token expired / invalid
        if (res.status === 401) {
            logout();
            return;
        }

        const data = await res.json();

        renderMessages(data);

    } catch (err) {

        document.getElementById("messages").innerText =
            "Server error. Try again later.";

    }

}


function renderMessages(messages) {

    const box = document.getElementById("messages");

    box.innerHTML = "";

    if (messages.length === 0) {
        box.innerText = "No messages yet.";
        return;
    }

    messages.forEach(msg => {

        const div = document.createElement("div");

        div.className = "message-card";

        if (msg.is_read) {
            div.classList.add("read");
        }

        div.innerHTML = `
            <p><strong>Name:</strong> ${msg.name}</p>
            <p><strong>Email:</strong> ${msg.email}</p>
            <p><strong>Message:</strong> ${msg.message}</p>
            <p><small>${new Date(msg.created_at).toLocaleString()}</small></p>

            <button onclick="toggleRead(${msg.id})">
                ${msg.is_read ? "Mark Unread" : "Mark Read"}
            </button>

            <button onclick="deleteMessage(${msg.id})">
                Delete
            </button>
        `;

        box.appendChild(div);

    });

}


// ================= TOGGLE READ =================

async function toggleRead(id) {

    try {

        const res = await fetch(
            API_URL + `/admin/messages/${id}/toggle-read`,
            {
                method: "PUT",
                headers: {
                    "Authorization": "Bearer " + token
                }
            }
        );

        if (res.status === 401) {
            logout();
            return;
        }

        loadMessages();

    } catch {
        alert("Failed to update message");
    }

}


// ================= DELETE =================

async function deleteMessage(id) {

    if (!confirm("Delete this message?")) return;

    try {

        const res = await fetch(
            API_URL + `/admin/messages/${id}`,
            {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            }
        );

        if (res.status === 401) {
            logout();
            return;
        }

        loadMessages();

    } catch {
        alert("Delete failed");
    }

}


// ================= LOGOUT =================

function logout() {

    localStorage.removeItem("ADMIN_TOKEN");

    window.location.href = "login.html";

}


// ================= INIT =================

loadMessages();

</script>

</body>
</html>